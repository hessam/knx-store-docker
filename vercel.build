#!/bin/bash

# Vercel Build Script for KNX Store
# This script runs during Vercel's build process

echo "ğŸš€ Starting Vercel build for KNX Store..."

# Set environment variables based on Vercel environment
if [ "$VERCEL_ENV" = "production" ]; then
  echo "ğŸ“¦ Building for production..."
  export NODE_ENV=production
  export SITE_URL=$VERCEL_URL
elif [ "$VERCEL_ENV" = "preview" ]; then
  echo "ğŸ” Building for preview..."
  export NODE_ENV=preview
  export SITE_URL=$VERCEL_URL
else
  echo "ğŸ§ª Building for development..."
  export NODE_ENV=development
  export SITE_URL=$VERCEL_URL
fi

# Install dependencies
echo "ğŸ“¥ Installing dependencies..."
npm ci --only=production

# Build the application
echo "ğŸ”¨ Building application..."
npm run build

# Run post-build optimizations
echo "âš¡ Running post-build optimizations..."

# Optimize images if they exist
if [ -d "dist" ]; then
  echo "ğŸ–¼ï¸ Optimizing images..."
  find dist -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" | head -10
fi

# Generate sitemap
echo "ğŸ—ºï¸ Generating sitemap..."
if [ -f "dist/sitemap-index.xml" ]; then
  echo "âœ… Sitemap generated successfully"
else
  echo "âš ï¸ Sitemap not found"
fi

# Check build output
echo "ğŸ“Š Build summary:"
echo "  - Environment: $VERCEL_ENV"
echo "  - Site URL: $SITE_URL"
echo "  - Build directory: dist/"
ls -la dist/ | head -5

echo "âœ… Vercel build completed successfully!" 