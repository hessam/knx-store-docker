---
import Layout from '../layouts/Layout.astro';

const title = 'Authentication & Payment Test - KNX Store';
---

<Layout title={title}>
  <main class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Authentication & Payment Test</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Authentication Test -->
      <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Authentication Test</h2>
        
        <div class="space-y-4">
          <div>
            <h3 class="font-medium text-gray-700 mb-2">Test Accounts:</h3>
            <div class="bg-gray-50 p-3 rounded-md text-sm">
              <p><strong>Admin:</strong> admin@knxstore.com / admin123</p>
              <p><strong>User:</strong> user@knxstore.com / user123</p>
            </div>
          </div>
          
          <div>
            <h3 class="font-medium text-gray-700 mb-2">Quick Links:</h3>
            <div class="space-y-2">
              <a href="/en/login" class="block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-center">
                Login Page
              </a>
              <a href="/en/account" class="block bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-center">
                Account Page
              </a>
              <button id="test-auth" class="w-full bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                Test Protected API
              </button>
            </div>
          </div>
          
          <div id="auth-result" class="hidden p-3 rounded-md">
            <p id="auth-message"></p>
          </div>
        </div>
      </div>

      <!-- Payment Test -->
      <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Test</h2>
        
        <div class="space-y-4">
          <div>
            <h3 class="font-medium text-gray-700 mb-2">Test Cards:</h3>
            <div class="bg-gray-50 p-3 rounded-md text-sm">
              <p><strong>Visa:</strong> 4242 4242 4242 4242</p>
              <p><strong>Mastercard:</strong> 5555 5555 5555 4444</p>
              <p><strong>Date:</strong> Any future date (e.g., 12/25)</p>
              <p><strong>CVC:</strong> Any 3 digits (e.g., 123)</p>
            </div>
          </div>
          
          <div>
            <h3 class="font-medium text-gray-700 mb-2">Quick Links:</h3>
            <div class="space-y-2">
              <a href="/en/checkout" class="block bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-center">
                Checkout Page
              </a>
              <button id="test-payment" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                Test Payment API
              </button>
            </div>
          </div>
          
          <div id="payment-result" class="hidden p-3 rounded-md">
            <p id="payment-message"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Display -->
    <div class="mt-8 bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">System Status</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="text-center">
          <div id="auth-status" class="text-2xl font-bold text-gray-400">?</div>
          <p class="text-sm text-gray-600">Authentication</p>
        </div>
        <div class="text-center">
          <div id="payment-status" class="text-2xl font-bold text-gray-400">?</div>
          <p class="text-sm text-gray-600">Payment Gateway</p>
        </div>
        <div class="text-center">
          <div id="overall-status" class="text-2xl font-bold text-gray-400">?</div>
          <p class="text-sm text-gray-600">Overall Status</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Test authentication
    document.getElementById('test-auth').addEventListener('click', async () => {
      const result = document.getElementById('auth-result');
      const message = document.getElementById('auth-message');
      
      try {
        const response = await fetch('/api/protected');
        const data = await response.json();
        
        if (response.ok) {
          result.className = 'bg-green-100 text-green-700 p-3 rounded-md';
          message.textContent = `Success! User: ${data.user.name} (${data.user.email})`;
        } else {
          result.className = 'bg-red-100 text-red-700 p-3 rounded-md';
          message.textContent = 'Authentication required. Please log in first.';
        }
      } catch (error) {
        result.className = 'bg-red-100 text-red-700 p-3 rounded-md';
        message.textContent = 'Error: ' + error.message;
      }
      
      result.classList.remove('hidden');
    });

    // Test payment
    document.getElementById('test-payment').addEventListener('click', async () => {
      const result = document.getElementById('payment-result');
      const message = document.getElementById('payment-message');
      
      try {
        const response = await fetch('/api/payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: 10.00,
            currency: 'usd',
            customerEmail: 'test@example.com',
            productId: 'test-product'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          result.className = 'bg-green-100 text-green-700 p-3 rounded-md';
          message.textContent = 'Payment intent created successfully!';
        } else {
          result.className = 'bg-red-100 text-red-700 p-3 rounded-md';
          message.textContent = 'Payment failed: ' + (data.error || 'Unknown error');
        }
      } catch (error) {
        result.className = 'bg-red-100 text-red-700 p-3 rounded-md';
        message.textContent = 'Error: ' + error.message;
      }
      
      result.classList.remove('hidden');
    });

    // Check system status
    async function checkSystemStatus() {
      const authStatus = document.getElementById('auth-status');
      const paymentStatus = document.getElementById('payment-status');
      const overallStatus = document.getElementById('overall-status');
      
      let authWorking = false;
      let paymentWorking = false;
      
      // Test auth
      try {
        const authResponse = await fetch('/api/login');
        authWorking = authResponse.ok;
      } catch (error) {
        console.error('Auth test failed:', error);
      }
      
      // Test payment
      try {
        const paymentResponse = await fetch('/api/payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: 1.00,
            currency: 'usd',
            customerEmail: 'test@example.com',
            productId: 'test-product'
          })
        });
        paymentWorking = paymentResponse.ok;
      } catch (error) {
        console.error('Payment test failed:', error);
      }
      
      // Update status indicators
      authStatus.textContent = authWorking ? '✅' : '❌';
      authStatus.className = authWorking ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
      
      paymentStatus.textContent = paymentWorking ? '✅' : '❌';
      paymentStatus.className = paymentWorking ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
      
      const overallWorking = authWorking && paymentWorking;
      overallStatus.textContent = overallWorking ? '✅' : '❌';
      overallStatus.className = overallWorking ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
    }
    
    // Check status on page load
    checkSystemStatus();
  </script>
</Layout>
